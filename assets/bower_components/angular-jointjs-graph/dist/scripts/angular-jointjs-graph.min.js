"use strict";angular.module("angular-jointjs-graph",["ngResource","angular-jointjs-graph/templates"]),angular.module("angular-jointjs-graph/templates",[]).run(["$templateCache",function(a){a.put("angular-joints-graph/templates/graph",'<div class="organogram">\n<section class="chartContainer">\n<div class="chartArea" droppable></div>\n<div ng-transclude></div>\n</section>\n</div>'),a.put("angular-joints-graph/templates/graphSidePanelTools",'<div class="graph-tools">\n<div class="basic">\n<div class="intro">Drag to create new</div>\n<div class="fabric"></div>\n</div>\n<div class="switch-container" ng-click="toggleExtended()" extended="{{showExtended}}">\n<div class="switch">\nor choose from existing\n<span ng-class="showExtended ? \'up\' : \'down\'"></span>\n</div>\n</div><div class="listing" ng-show="showExtended">\n<ul></ul>\n</div>\n</div>'),a.put("angular-joints-graph/templates/graphSidePanelDetails","<div ng-transclude></div>"),a.put("angular-joints-graph/templates/graphNewEntity",'<div class="instance-template" draggable></div>'),a.put("angular-joints-graph/templates/graphExistingEntities",'<li class="entity-item"ng-repeat="entity in entities"ng-hide="entity.show == false"draggable graph-existing-entity="{{entityIdentifier}}">\n<div class="remove-entity" ng-click="removeEntity(entity)">&times;</div>\n</li>')}]),angular.module("angular-jointjs-graph").directive("draggable",["$window",function(a){return function(b,c){var d=c[0];d.draggable=!0,d.addEventListener("dragstart",function(b){b.dataTransfer.effectAllowed="copy",this.classList.add("drag");var c=b.clientX-b.target.getBoundingClientRect().left,e=b.clientY-b.target.getBoundingClientRect().top,f=a.g.point(c,e);b.dataTransfer.setData("text",JSON.stringify({"entity-attributes":d.dataset,"pointer-offset":f}))}),d.addEventListener("dragend",function(){this.classList.remove("drag")})}}]),angular.module("angular-jointjs-graph").directive("droppable",["$window",function(a){return{link:function(b,c){var d=c[0];d.addEventListener("dragover",function(a){a.preventDefault(),a.dataTransfer.dropEffect="copy"}),d.addEventListener("drop",function(d){d.stopPropagation();var e=JSON.parse(d.dataTransfer.getData("text")),f=e["pointer-offset"],g=c[0].getBoundingClientRect(),h=Math.floor(d.clientX-g.left-f.x),i=Math.floor(d.clientY-g.top-f.y),j=a.g.point(h,i),k=e["entity-attributes"];b.$emit("graphDropEvent",{entityAttributes:k,dropPoint:j})})}}}]),angular.module("angular-jointjs-graph").directive("graph",["JointGraph","JointChartNode","JointElementView","JointNodeModel","JointPaper","$q","GraphHelpers","GraphEntities","GraphLinks","GraphSelection","JointGraphResources",function(a,b,c,d,e,f,g,h,i,j,k){return{restrict:"E",templateUrl:"angular-joints-graph/templates/graph",transclude:!0,controller:["$scope","$element","$attrs",function(d,l){function m(){c.init(l.find(".chartContainer")),e.init(l.find(".chartArea")),e.onSelectionChange(function(a){j.select(a),d.$digest()}),e.onCellPositionChange(function(){d.saveGraph()}),a.on("add",function(a){a.get("isChartNode")?(a.on("createLinkStart",o),a.on("createLinkEnd",p),a.on("nodeRemoved",q)):a.on("remove",r)}),n()}function n(){var b=d.graph.content?JSON.parse(d.graph.content):{};b.cells&&(b.cells.forEach(function(a){a.isChartNode&&h.markPresentOnGraph(a)}),a.addCells(b.cells))}function o(){d.$apply(function(){j.clearAndRevert()})}function p(b){var c=a.getCell(b);d.$apply(function(){c.createResource().then(function(a){i.addSingle(a),d.saveGraph()},function(a){d.$emit("applicationError",{errData:a}),c.remove({skipCallbacks:!0})})})}function q(a,b){a.preventDefault(),d.$apply(function(){var a=h.getSingle(b),c=j.getSelectedEntity();a&&(a===c&&j.clear(),h.markRemovedFromGraph(b),d.saveGraph())})}function r(a,b,c){if(c&&c.skipCallbacks);else{var e=i.getSingle(a);e&&e.$remove().then(function(){i.remove(a),c&&c.skipGraphSave||d.saveGraph()},function(a){d.$emit("applicationError",{errData:a})})}}function s(a){var b=f.defer(),c=a.get("backendModelParams")[g.getModelIdKey()];return"undefined"===c?a.createResource().then(function(c){h.addSingle(a,c),b.resolve({newNode:!0})},function(a){b.reject(a)}):(h.markPresentOnGraph(a),b.resolve({newNode:!1})),b.promise}function t(a){var b=e.getPaper().findViewByModel(a);e.clearSelection(),j.select(e.selectCell(b))}d.$on("graphResources",function(a,b){k.set(b),b.graph.$get().then(function(a){return d.graph=a,Object.keys(b.entities).map(function(a){return{key:a,promise:g.queryResource(b.entities[a])}}).reduce(function(a,b){return a.then(function(a){return b.promise.then(function(c){return a[b.key]=c,a})})},f.when({}))}).then(function(a){return h.set(a),d.$broadcast("graphEntitiesLoaded",a),g.queryResource(b.entityRelations)}).then(function(a){i.set(a),d.$broadcast("graphEntityRelationsLoaded",a)}).then(function(){d.$broadcast("graphResourcesLoaded"),m()},function(a){d.$emit("applicationError",{errData:a})})}),d.clearCellSelectionAndRevert=function(){j.clearAndRevert()},d.revertSelection=function(){j.revertSelection()},d.syncSelection=function(){j.syncSelection()},d.selectEntity=function(a,b){j.selectEntity(a,b)},d.saveGraph=function(){setTimeout(function(){d.graph.content=JSON.stringify(a.toJSON()),d.graph.$update()["catch"](function(a){d.$emit("applicationError",{errData:a})})},0)},d.$on("removeEntity",function(a,b){a.stopPropagation(),b.entity.$remove().then(function(){h.remove(b.entity,b.identifier)},function(a){d.$emit("applicationError",{errData:a})})}),j.onSelectionChange(function(a){d.$broadcast("graphSelection",a)}),d.$on("graphDropEvent",function(c,e){c.stopPropagation(),d.$apply(function(){var c=b.create(e.entityAttributes,e.dropPoint);a.addCell(c),s(c).then(function(a){a.newNode&&t(c),d.saveGraph()},function(a){d.$emit("applicationError",{errData:a}),c.remove()})})})}]}}]),angular.module("angular-jointjs-graph").directive("graphExistingEntities",["GraphEntities",function(a){return{require:"^graphSidePanelTools",restrict:"E",templateUrl:"angular-joints-graph/templates/graphExistingEntities",transclude:!0,scope:!0,controller:["$scope","$attrs","$transclude",function(b,c,d){b.transcludeEntities=d,b.entityIdentifier=c.entityIdentifier,b.$on("graphResourcesLoaded",function(){b.entities=a.getForType(b.entityIdentifier)}),b.removeEntity=function(a){b.$emit("removeEntity",{entity:a,identifier:b.entityIdentifier})}}]}}]),angular.module("angular-jointjs-graph").directive("graphExistingEntity",["GraphHelpers",function(a){return{require:"^graphExistingEntities",restrict:"A",link:function(b,c,d){var e=d.graphExistingEntity,f=a.entityProperties(e),g=c[0];f.forEach(function(a){g.dataset[a]=b.entity[a],b.$watch("entity."+a,function(b){g.dataset[a]=b})}),g.dataset.entityIdentifier=e,b.transcludeEntities(b,function(a){c.append(a)})}}}]),angular.module("angular-jointjs-graph").directive("graphNewEntity",["GraphHelpers",function(a){return{require:"^graphSidePanelTools",restrict:"E",templateUrl:"angular-joints-graph/templates/graphNewEntity",transclude:!0,link:function(b,c,d,e,f){var g=c.find(".instance-template"),h=d.entityIdentifier,i=a.entityProperties(h);i&&i.forEach(function(a){g[0].dataset[a]=void 0}),g[0].dataset.entityIdentifier=h,f(b,function(a){g.append(a)})}}}]),angular.module("angular-jointjs-graph").directive("graphSidePanelDetails",[function(){return{require:"^graph",scope:!0,restrict:"E",templateUrl:"angular-joints-graph/templates/graphSidePanelDetails",transclude:!0}}]),angular.module("angular-jointjs-graph").directive("graphSidePanelTools",[function(){return{require:"^graph",restrict:"E",templateUrl:"angular-joints-graph/templates/graphSidePanelTools",transclude:!0,controller:["$scope",function(a){a.showExtended=!1,a.toggleExtended=function(){a.showExtended=!a.showExtended}}],compile:function(){return{post:function(a,b,c,d,e){e(a,function(a){b.find("div.fabric").append(a.siblings("graph-new-entity").addBack()),b.find("ul").append(a.siblings("graph-existing-entities"))})}}}}}]),angular.module("angular-jointjs-graph").provider("FactoryMap",[function(){var a={};this.register=function(b,c){a[c||b]=b},this.$get=["$injector",function(b){return{get:function(c){try{return a[c]?b.get(a[c],null):null}catch(d){return null}}}}]}]),angular.module("angular-jointjs-graph").factory("GraphEntities",["GraphHelpers",function(a){function b(b){var c=b.backendModelParams||b.get("backendModelParams"),d=c.entityIdentifier,e=a.getModelIdKey(),f=c[e];return{typeIdentifier:d,uniqueId:f,modelIdKey:e}}function c(a){return d[a.typeIdentifier].filter(function(b){return b[a.modelIdKey]===a.uniqueId})[0]}var d={},e={};return{set:function(a){Object.keys(a).forEach(function(b){d[b]=a[b],e[b]={}})},addSingle:function(a,c){var f=b(a);c.show=!1,e[f.typeIdentifier][f.uniqueId]=a.id,d[f.typeIdentifier].unshift(c)},getSingle:function(a){return c(b(a))},getForType:function(a){return d[a]},markPresentOnGraph:function(a){var d=b(a);e[d.typeIdentifier][d.uniqueId]=a.id;var f=c(d);f&&(f.show=!1)},markRemovedFromGraph:function(a){var d=b(a);delete e[d.typeIdentifier][d.uniqueId];var f=c(d);f&&(f.show=!0)},jointModelId:function(b,c){return e[b][c[a.getModelIdKey()]]},remove:function(b,c){var f=b[a.getModelIdKey()],g=d[c].indexOf(b);delete e[c][f],d[c].splice(g,1)}}}]),angular.module("angular-jointjs-graph").factory("GraphHelpers",["$q","JointGraphConfig",function(a,b){function c(a){var c,d=b.modelIdKey||"id";return c=a?b.entityModelProperties?b.entityModelProperties[a]:null:b.linkModelProperties,angular.isArray(c)?angular.copy(c).concat(d):[d]}function d(){return b.modelIdKey?b.modelIdKey:"id"}return{queryResource:function(b){var c=a.defer();return b.query(function(a){c.resolve(a)},function(a){c.reject(a)}),c.promise},getModelIdKey:d,entityProperties:function(a){return c(a)},linkProperties:function(){return c()}}}]),angular.module("angular-jointjs-graph").factory("GraphLinks",["GraphHelpers",function(a){function b(b){var d=b.get("backendModelParams"),e=a.getModelIdKey();return c.filter(function(a){return a[e]===d[e]})[0]}var c=[];return{set:function(a){c=a},addSingle:function(a){c.push(a)},getSingle:function(a){return b(a)},remove:function(a){c.splice(c.indexOf(b(a)),1)}}}]),angular.module("angular-jointjs-graph").factory("GraphSelection",["JointGraph","JointPaper","GraphHelpers","GraphEntities","GraphLinks","FactoryMap",function(a,b,c,d,e,f){function g(){var b=a.getCell(j.selectedCellId);if(b){var d={},e=b.get("isChartNode"),g=f.get(e?"JointNodeParams":"JointLinkParams");if(g){var h=e?c.entityProperties(j.entityIdentifier):c.linkProperties();h.forEach(function(a){d[a]=j.selectedResource[a]});var i=g.computed(d);i&&b.attr(i)}}}function h(){angular.isFunction(k)&&k(j)}function i(){j&&(angular.copy(j.masterResource,j.selectedResource),g())}var j,k;return{onSelectionChange:function(a){k=a},select:function(b){if(i(),b){var c=a.getCell(b.selectedCellId),f=b.isChartNode?d.getSingle(c):e.getSingle(c);j={isChartNode:b.isChartNode,selectedResource:f,selectedCellId:b.selectedCellId,masterResource:angular.copy(f),entityIdentifier:b.entityIdentifier}}else j=null;h()},selectEntity:function(a,b){i(),j={isChartNode:!0,selectedResource:a,selectedCellId:d.jointModelId(b,a),masterResource:angular.copy(a),entityIdentifier:b},h()},getSelectedEntity:function(){return j?j.selectedResource:null},revertSelection:function(){j&&(angular.copy(j.masterResource,j.selectedResource),g(),h())},syncSelection:function(){j&&(angular.copy(j.selectedResource,j.masterResource),g(),h())},clear:function(){b.clearSelection(),j=null,h()},clearAndRevert:function(){b.clearSelection(),i(),j=null,h()}}}]),angular.module("angular-jointjs-graph").factory("JointChartLink",["$q","JointLinkDefaults","JointResourceModel","FactoryMap","GraphHelpers","JointGraphResources",function(a,b,c,d,e,f){return{create:function(a){var g=d.get("LinkFactory")||{};g.resource=f.get().entityRelations;var h=c.forLink(g),i={},j=e.linkProperties();j.forEach(function(a){i[a]="undefined"});var k={backendModelParams:i,attrs:b.get(i).attrs,isChartNode:!1};return h.create(angular.extend(k,a))}}}]),angular.module("angular-jointjs-graph").factory("JointChartNode",["JointResourceModel","FactoryMap","GraphHelpers","JointGraphResources",function(a,b,c,d){function e(e){if("undefined"===e[c.getModelIdKey()]){var f=e.entityIdentifier,g=b.get(f)||{};return g.resource=d.get().entities[f],a.forNewEntity(g)}return a.forExistingEntity()}return{create:function(a,c){var d=e(a),f=b.get("JointNodeParams"),g={position:{x:c.x,y:c.y},backendModelParams:a,options:{interactive:!0},isChartNode:!0};return f&&(g.attrs=f.computed(a)),d.create(g)}}}]),angular.module("angular-jointjs-graph").factory("JointElementView",["$window","JointChartLink",function(a,b){function c(c){a.joint.shapes.html.ElementView=a.joint.dia.ElementView.extend({link:null,canUpdateLink:!1,render:function(){a.joint.dia.ElementView.prototype.render.apply(this,arguments),this.findBySelector(".connection-port").on("mousedown",this.createLink.bind(this));var b=this.findBySelector(".remove-element"),c=this;return b.on("mousedown",function(a){a.stopPropagation()}),b.on("click",function(a){c.paper.model.getConnectedLinks(c.model).forEach(function(a){a.remove({skipGraphSave:!0})}),c.model.remove(),c.model.trigger("nodeRemoved",a,c.model)}),this.paper.$el.mousemove(this.onMouseMove.bind(this)),this.paper.$el.mouseup(this.onMouseUp.bind(this)),this},createLink:function(c){var d=this.paper.$el.offset(),e=$(c.target).offset(),f=e.left-d.left,g=e.top-d.top;c.stopPropagation(),a.V(this.el).addClass("source-view"),this.model.trigger("createLinkStart"),this.link=b.create({source:{id:this.model.get("id")},target:a.g.point(f,g)}),this.paper.model.addCell(this.link),this.linkView=this.paper.findViewByModel(this.link),this.linkView.startArrowheadMove("target"),this.link.on("change:target",function(a){a.invalidTarget()||a.allowed()?(a.colorLinkAllowed(),a.removeLinkLabels(),a.removeForbiddenHighlight()):(a.colorLinkForbidden(),a.addLinkForbiddenLabel(),a.addForbiddenHighlight())}),this.canUpdateLink=!0},onMouseUp:function(b){this.linkView&&(this.link.addLinkMidpoint(),a.V(this.el).removeClass("source-view"),this.linkView.pointerup(b,b.clientX,b.clientY),this.link.colorLinkCreated(),this.link.removeForbiddenHighlight(),this.link.allowed()?this.model.trigger("createLinkEnd",this.link.id,this.link.get("target").id):this.link.remove({skipCallbacks:!0}),delete this.linkView,this.model.trigger("batch:stop")),this.canUpdateLink=!1,this.paper.$el.find(".component").css("z-index",1)},onMouseMove:function(b){if(this.link&&this.canUpdateLink&&!(b.clientX<=10)){this.linkView&&this.linkView.pointermove(b,b.clientX,b.clientY);var d=c[0].getBoundingClientRect();this.link.set("target",a.g.point(b.clientX-d.left,b.clientY-d.top))}}})}return{init:function(a){c(a)}}}]),angular.module("angular-jointjs-graph").factory("JointGraph",["$window",function(a){return new a.joint.dia.Graph}]),angular.module("angular-jointjs-graph").provider("JointGraphConfig",["FactoryMapProvider",function(a){var b;this.init=function(c){b=c,a.register(b.linkCreationCallbacks,"LinkFactory"),a.register(b.entityMarkupParams,"JointNodeParams"),a.register(b.linkMarkupParams,"JointLinkParams"),Object.keys(b.entityCreationCallbacks).forEach(function(c){a.register(b.entityCreationCallbacks[c],c)})},this.$get=[function(){if(b)return b;throw new Error("JointGraphConfig provider must be initialized in a config block")}]}]),angular.module("angular-jointjs-graph").factory("JointGraphResources",[function(){var a;return{set:function(b){a=b},get:function(){return a}}}]),angular.module("angular-jointjs-graph").factory("JointLinkDefaults",["FactoryMap",function(a){var b={attrs:{".marker-target":{d:"M 10 0 L 0 5 L 10 10 z"},".marker-source":{display:"none"},".marker-vertex-remove-area":{display:"none"},".marker-vertex-remove":{display:"none"}},linkForbiddenLabel:{position:.5,attrs:{text:{text:"  Link not allowed  "}}}};return{get:function(c){var d=a.get("JointLinkParams");return d&&angular.extend(b,d.get(c)),b}}}]),angular.module("angular-jointjs-graph").factory("JointLinkModel",["$window","JointPaper","JointLinkDefaults",function(a,b,c){function d(){function d(c){var d,e=b.getPaper(),f=e.findViewByModel(c),g=f.sourceView;if(f.targetView)d=f.targetView;else{var h=c.get("target");d=e.findViewsFromPoint(a.g.point(h.x,h.y))[0]}return[g,d]}if(e)return e;var f=c.get();return e=a.joint.dia.Link.extend(),e.prototype.colorLinkAllowed=function(){var c=a.V(b.getPaper().findViewByModel(this).el);c.removeClass("forbidden"),c.addClass("allowed")},e.prototype.colorLinkForbidden=function(){var c=a.V(b.getPaper().findViewByModel(this).el);c.removeClass("allowed"),c.addClass("forbidden")},e.prototype.colorLinkCreated=function(){var c=a.V(b.getPaper().findViewByModel(this).el);c.removeClass("allowed"),c.removeClass("forbidden")},e.prototype.addLinkForbiddenLabel=function(){this.set("labels",[f.linkForbiddenLabel])},e.prototype.removeLinkLabels=function(){this.unset("labels")},e.prototype.toggleForbiddenHighlight=function(b){d(this).forEach(function(c){if(c){var d=a.V(c.el),e=b?d.addClass:d.removeClass;e.call(d,"nolink")}})},e.prototype.addForbiddenHighlight=function(){this.toggleForbiddenHighlight(!0)},e.prototype.removeForbiddenHighlight=function(){this.toggleForbiddenHighlight(!1)},e.prototype.addLinkMidpoint=function(){var c=b.getPaper().findViewByModel(this),d=a.g.line(a.g.point(c.sourcePoint),a.g.point(c.targetPoint)).midpoint();this.set("vertices",[{x:d.x,y:d.y}]),this.attr(".marker-vertex/r","5")},e.prototype.allowed=function(){return this.invalidTarget()?!1:f.canCreateLink?f.canCreateLink.apply(null,d(this)):!0},e.prototype.invalidTarget=function(){var a=d(this),b=!a[1],c=a[0]===a[1];return b||c},e}var e;return{getConstructor:d}}]),angular.module("angular-jointjs-graph").factory("JointNodeModel",["$window","$templateCache","FactoryMap",function(a,b,c){var d=a.joint.shapes.basic.Generic.extend({markup:b.get("graphNode"),defaults:a.joint.util.deepSupplement({type:"html.Element",attrs:c.get("JointNodeParams").defaults},a.joint.shapes.basic.Generic.prototype.defaults)});return a.joint.shapes.html={Element:d},{getConstructor:function(){return d}}}]),angular.module("angular-jointjs-graph").factory("JointPaper",["$window","JointGraph","GraphHelpers",function(a,b,c){var d,e;return{init:function(c){d=new a.joint.dia.Paper({el:c[0],width:"100%",height:"100%",gridSize:1,model:b,interactive:{vertexAdd:!1},perpendicularLinks:!0})},getPaper:function(){return d},clearSelection:function(){if(e){var c=b.getCell(e);if(c){var f=d.findViewByModel(c);a.V(f.el).removeClass("selected")}e=null}},selectCell:function(b){a.V(b.el).addClass("selected"),e=b.model.get("id");var d=b.model.get("backendModelParams"),f=b.model.get("isChartNode")?!0:!1,g=c.getModelIdKey(),h=d[g],i=d.entityIdentifier;return{backendModelId:h,selectedCellId:e,isChartNode:f,entityIdentifier:i}},onSelectionChange:function(a){var b=this;d.on("blank:pointerdown",function(){b.clearSelection(),a(null)}),d.on("cell:pointerclick",function(c){b.clearSelection(),a(b.selectCell(c))})},onCellPositionChange:function(a){var b,c;d.on("cell:pointerdown",function(a,d,e){b=d,c=e}),d.on("cell:pointerup",function(d,e,f){if(b&&c){var g=Math.abs(b-e),h=Math.abs(c-f);(g>10||h>10)&&a(),b=null,c=null}})}}}]),angular.module("angular-jointjs-graph").factory("JointResourceModel",["JointNodeModel","JointLinkModel","$q",function(a,b,c){function d(a){function b(a){c.call(this,a)}var c=a.getConstructor();return b.prototype=Object.create(c.prototype),b.prototype.constructor=c,b}function e(a){return{create:function(b){return new a(b)}}}function f(a,b){var f=d(a);return f.prototype.createResource=function(){var a=c.defer(),d={},e=this;return angular.isFunction(b.postDataFn)&&(d=b.postDataFn(this)),b.resource.save({},d,function(c){var d=e.get("backendModelParams");Object.keys(d).forEach(function(a){c.hasOwnProperty(a)&&(d[a]=c[a])}),angular.isFunction(b.modelUpdateCallback)&&b.modelUpdateCallback(e,c),a.resolve(c)},function(b){a.reject(b)}),a.promise},new e(f)}return{forExistingEntity:function(){return new e(d(a))},forNewEntity:function(b){return f(a,b)},forLink:function(a){return f(b,a)}}}]);